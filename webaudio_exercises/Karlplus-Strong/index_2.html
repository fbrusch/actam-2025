<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    button {
      padding: 6px 12px;
      margin-bottom: 12px;
    }
    .steps {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .step {
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 8px;
      width: 120px;
    }
    .step.active {
      border-color: #007bff;
      background: #e6f0ff;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      gap: 4px;
    }
    .sliders label {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <button id="startStop">Start</button>
  <button id="toggleComp">Bypass Compressor</button>
  <div class="steps">
    <label class="step">Step 1
      <input class="noteSlider" type="range" min="-12" max="12" value="0">
    </label>
    <label class="step">Step 2
      <input class="noteSlider" type="range" min="-12" max="12" value="3">
    </label>
    <label class="step">Step 3
      <input class="noteSlider" type="range" min="-12" max="12" value="7">
    </label>
    <label class="step">Step 4
      <input class="noteSlider" type="range" min="-12" max="12" value="8">
    </label>
  </div>
  <div class="sliders">
    <label>Attack (ms)
      <input id="attackSlider" type="range" min="5" max="200" value="20">
    </label>
    <label>Release (ms)
      <input id="releaseSlider" type="range" min="50" max="1000" value="120">
    </label>
    <label>Tempo (BPS)
      <input id="tempoSlider" type="range" min="1" max="8" value="2.4">
    </label>
  </div>

  <script>
    const c = new AudioContext();
    const noteSliders = Array.from(document.querySelectorAll('.noteSlider'));
    const stepLabels = Array.from(document.querySelectorAll('.step'));
    const attackSlider = document.getElementById('attackSlider');
    const releaseSlider = document.getElementById('releaseSlider');
    const tempoSlider = document.getElementById('tempoSlider');
    const startStop = document.getElementById('startStop');
    let currentStep = 0;
    let isPlaying = false;
    let intervalId = null;

    function noteToFreq(semitones) {
      return 440 * Math.pow(2, semitones / 12);
    }

    function highlightStep(index) {
      stepLabels.forEach((label, i) => {
        label.classList.toggle('active', i === index);
      });
    }

    function clearHighlight() {
      stepLabels.forEach(label => label.classList.remove('active'));
    }

    const compressor = c.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-24, c.currentTime); // in dB
    compressor.knee.setValueAtTime(30, c.currentTime);
    compressor.ratio.setValueAtTime(12, c.currentTime);
    compressor.attack.setValueAtTime(0.003, c.currentTime);
    compressor.release.setValueAtTime(0.25, c.currentTime);
    compressor.connect(c.destination);
    let compressorBypassed = true;

    function connectNode(node) {
      if (compressorBypassed) {
        node.connect(c.destination);
      } else {
        node.connect(compressor);
      }
    }

    // KARPLUS–STRONG IMPLEMENTATION

    // 1. White noise source
    const noiseBufferSize = c.sampleRate; 
    const noiseBuffer = c.createBuffer(1, noiseBufferSize, c.sampleRate);
    const noiseData = noiseBuffer.getChannelData(0);
    for (let i = 0; i < noiseBufferSize; i++) {
      noiseData[i] = Math.random() * 2 - 1; // [-1, 1]
    }

    const noiseSource = new AudioBufferSourceNode(c, { loop: true });
    noiseSource.buffer = noiseBuffer;

    const noiseGain = c.createGain();
    noiseGain.gain.value = 0; // we open it only when plucking

    // 2. Delay + feedback 
    const delayNode = c.createDelay();
    delayNode.delayTime.value = 1 / 440; 

    const feedbackGain = c.createGain();
    feedbackGain.gain.value = 0.99; // it controls the decay time

    // 3. Internal connections Karplus–Strong
    noiseSource.connect(noiseGain);
    noiseGain.connect(delayNode);
    delayNode.connect(feedbackGain);
    feedbackGain.connect(delayNode); // feedback loop

    // 4. Start the noise source, initially silent
    noiseSource.start();

    // Function that performs a Karplus–Strong "pluck" at a given frequency
    function pluckKarplus(freq, attack, release, startTime) {
      // Set delay length based on frequency (period ≈ 1/f)
      delayNode.delayTime.setValueAtTime(1 / freq, startTime);

      // Output node for this note
      const outGain = c.createGain();
      outGain.gain.setValueAtTime(0, startTime);
      outGain.gain.linearRampToValueAtTime(1, startTime + attack);
      outGain.gain.linearRampToValueAtTime(0, startTime + attack + release);

      // Take the signal from the string loop (feedback) and a bit from the noise source
      feedbackGain.connect(outGain);
      noiseGain.connect(outGain);

      // Connect the output to the compressor / destination
      connectNode(outGain);

      // Burst of noise: "pluck" the string
      noiseGain.gain.cancelScheduledValues(startTime);
      noiseGain.gain.setValueAtTime(1, startTime);
      noiseGain.gain.linearRampToValueAtTime(0, startTime + attack);
    }


    async function playStep() {
      await c.resume();
      const now = c.currentTime;
      const attack = attackSlider.value / 1000;  // ms -> s
      const release = releaseSlider.value / 1000;

      const semitones = parseInt(noteSliders[currentStep].value, 10);
      const freq = noteToFreq(semitones);

      highlightStep(currentStep);
      pluckKarplus(freq, attack, release, now);

      currentStep = (currentStep + 1) % noteSliders.length;
    }

    function startSequencer() {
      if (isPlaying) return;
      isPlaying = true;
      startStop.textContent = 'Stop';
      const interval = 1000 / parseInt(tempoSlider.value, 10); // BPS -> ms
      playStep();
      intervalId = setInterval(() => {
        playStep();
      }, interval);
    }

    function stopSequencer() {
      isPlaying = false;
      startStop.textContent = 'Start';
      currentStep = 0;
      clearHighlight();
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    startStop.addEventListener('click', () => {
      if (isPlaying) {
        stopSequencer();
      } else {
        startSequencer();
      }
    });

    tempoSlider.addEventListener('change', () => {
      if (isPlaying) {
        stopSequencer();
        startSequencer();
      }
    });

    document.getElementById('toggleComp').addEventListener('click', () => {
      compressorBypassed = !compressorBypassed;
      document.getElementById('toggleComp').textContent =
        compressorBypassed ? 'Bypass Compressor' : 'Use Compressor';
    });
  </script>
</body>
</html>
