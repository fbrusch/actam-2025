<!DOCTYPE html>
<html>
  <body>
    <h1>Lezione Web MIDI: Performance</h1>
    
    <button id="start">Clicca per attivare Audio</button>
    
    <!-- VISUALIZZATORE OTTIMIZZATO -->
    <div style="margin: 20px 0;">
        <strong>Filtro (CC): </strong> <span id="cc-value-display">0</span>
        
        <div style="border: 2px solid #333; width: 300px; height: 30px; background: #eee; overflow: hidden; margin-top: 5px;">
            <!-- Usa transform-origin left per farla crescere da sinistra -->
            <div id="visual-bar" style="width: 100%; height: 100%; background-color: #ff0055; transform: scaleX(0); transform-origin: left; will-change: transform;"></div>
        </div>
    </div>

    <!-- LOG MESSAGGI (Solo Note) -->
    <div id="log" style="font-family: monospace; white-space: pre; background: #f0f0f0; padding: 10px; height: 200px; overflow-y: scroll;"></div>

    <script>
      const logDiv = document.getElementById("log");
      const barDiv = document.getElementById("visual-bar");
      const ccDisplay = document.getElementById("cc-value-display"); // Riferimento al numerino

      const print = (msg) => (logDiv.innerText = msg + "\n" + logDiv.innerText);

      let audioCtx;
      let currentFilterVal = 1000; 
      const activeOscillators = {}; 

      document.getElementById("start").addEventListener("click", async () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        print("Audio Context attivo!");
        setupMIDI();
      });

      async function setupMIDI() {
        if (!navigator.requestMIDIAccess) return print("Niente MIDI!");
        
        const access = await navigator.requestMIDIAccess();
        for (let input of access.inputs.values()) {
          input.onmidimessage = handleMIDIMessage;
        }
        print("MIDI pronto.");
      }

      function handleMIDIMessage(msg) {
        const [command, data1, data2] = msg.data;

        // --- NOTE (Pochi eventi -> OK Loggare) ---
        if (command === 144 && data2 > 0) {
            playNote(data1);
            print(`Note On: ${data1}`);
        }
        
        if (command === 128 || (command === 144 && data2 === 0)) {
            stopNote(data1);
            print(`Note Off: ${data1}`);
        }

        // --- CC (Migliaia di eventi -> NO Log, solo update visivo) ---
        if (command === 176) {
          const value = data2;
          
          // 1. Aggiorniamo solo il numerino (leggerissimo)
          ccDisplay.innerText = value;

          // 2. Aggiorniamo la barra usando GPU (scaleX) invece di CPU (width)
          const percent = value / 127; 
          barDiv.style.transform = `scaleX(${percent})`;
          
          // 3. Audio mapping
          currentFilterVal = 50 + (value / 127) * 5000;
          updateActiveFilters(currentFilterVal);
          
          // NOTA: Abbiamo rimosso il print() qui! 
          // È quello che salvava la CPU.
        }
      }

      function playNote(note) {
        const osc = audioCtx.createOscillator();
        const filter = audioCtx.createBiquadFilter();
        const gain = audioCtx.createGain();

        const freq = 440 * Math.pow(2, (note - 69) / 12);
        osc.type = "sawtooth";
        osc.frequency.value = freq;

        filter.type = "lowpass";
        filter.frequency.value = currentFilterVal;

        gain.gain.value = 0.1;

        osc.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        activeOscillators[note] = { osc, gain, filter };
      }

      function stopNote(note) {
        const active = activeOscillators[note];
        if (active) {
          active.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
          active.osc.stop(audioCtx.currentTime + 0.1);
          delete activeOscillators[note];
        }
      }

      function updateActiveFilters(val) {
        for (const note in activeOscillators) {
            // setTargetAtTime è molto più efficiente di setValueAtTime per aggiornamenti continui
            activeOscillators[note].filter.frequency.setTargetAtTime(val, audioCtx.currentTime, 0.02);
        }
      }
    </script>
  </body>
</html>